name: Quality Lens Analysis

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  analyze:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Install project dependencies
        run: npm ci
        continue-on-error: true
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Install Quality Lens CLI
        run: npm install -g @principal-ai/quality-lens-cli

      - name: Run quality lenses
        run: quality-lens run . --install --output results.json --format json

      - name: Display results summary
        if: always()
        run: |
          if [ -f results.json ]; then
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "                    QUALITY LENS RESULTS"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            node -e "
              const fs = require('fs');
              const results = JSON.parse(fs.readFileSync('results.json', 'utf8'));

              // Show hexagon scores (use first package for single-package repos)
              const hex = results.qualityMetrics?.packages?.[0]?.hexagon || {};
              console.log('');
              console.log('Quality Hexagon Scores:');
              console.log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
              const dimensions = ['tests', 'linting', 'types', 'formatting', 'deadCode', 'documentation'];
              for (const dim of dimensions) {
                const score = hex[dim] ?? 0;
                const bar = 'â–ˆ'.repeat(Math.floor(score / 10)) + 'â–‘'.repeat(10 - Math.floor(score / 10));
                const status = score === 0 ? 'âš ï¸  NEEDS SETUP' : score >= 80 ? 'âœ…' : score >= 50 ? 'âš¡' : 'âš ï¸';
                console.log(`  ${dim.padEnd(14)} ${bar} ${score.toString().padStart(3)}% ${status}`);
              }

              // Show lens details
              console.log('');
              console.log('Lens Execution Details:');
              console.log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
              for (const r of results.results) {
                const success = r.execution?.success;
                const hasIssues = (r.issues?.length || 0) > 0;
                const hasMetrics = r.metrics && Object.keys(r.metrics).length > 0;
                const exitCode = r.execution?.exitCode;

                let status = 'âœ… OK';
                let note = '';

                if (!success) {
                  status = 'âŒ FAILED';
                  note = ' - Tool could not run';
                } else if (!hasMetrics && !hasIssues) {
                  status = 'âš ï¸  NO DATA';
                  if (exitCode === 2) {
                    note = ' - Config error (check eslint/tsconfig)';
                  } else {
                    note = ' - Could not parse output';
                  }
                } else if (hasIssues) {
                  status = `ğŸ“‹ ${r.issues.length} issues`;
                }

                console.log(`  ${r.lens.id.padEnd(12)} ${status}${note}`);
              }

              // Show action items if needed
              const needsAttention = results.results.filter(r =>
                !r.execution?.success ||
                (!r.issues?.length && !r.metrics?.totalIssues && r.execution?.exitCode !== 0)
              );

              if (needsAttention.length > 0) {
                console.log('');
                console.log('âš ï¸  ACTION REQUIRED:');
                console.log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
                console.log('Some lenses could not run properly. Common fixes:');
                console.log('  â€¢ ESLint: Ensure .eslintrc or eslint.config.js exists');
                console.log('  â€¢ Jest: Ensure jest.config.js and test files exist');
                console.log('  â€¢ TypeScript: Ensure tsconfig.json is valid');
                console.log('  â€¢ Run "npm ci" locally to verify dependencies');
              }

              console.log('');
            "
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          fi

      - name: Upload results artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: quality-lens-results-${{ github.sha }}
          path: results.json
          if-no-files-found: warn
